<!DOCTYPE HTML>
<html lang="en-US">

<head>
    <title>React-admin - Documentation</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="HandheldFriendly" content="true" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/syntax.css">
    <link rel="stylesheet" href="css/prism.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/4.4.0/font/octicons.css">
</head>

<body>
    <div class="book with-summary font-size-2 font-family-1">
        <div id="book-summary" class="book-summary">
            <nav role="navigation">
                <ul class="summary">
                    <li class="header">Table of Contents</li>
                    <li class="chapter active">
                        <a href="./index.html">
                            <b>1.</b> Read Me
                        </a>
                    </li>
                    <li class="chapter ">
                        <a href="./pool.html">
                            <b>2.</b> Pool
                        </a>
                        <ul class="articles" style="display:none" >
                            <li class="chapter">
                                <a href="#connection">
                                    <code>Connection</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#namedQuery">
                                    <code>namedQuery</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#link">
                                    <code>link</code>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="header">Query Builder</li>
                    <li class="chapter ">
                        <a href="./queryBuilder.html">
                            <b>1.</b> Basic principe
                        </a>
                    </li>
                    <li class="chapter ">
                        <a href="./configuration.html">
                            <b>2.</b> Configuration
                        </a>
                        <ul class="articles" style="display:none" >
                            <li class="chapter">
                                <a href="#table">
                                    <code>Table</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#primaryKey">
                                    <code>primaryKey</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#returnCols">
                                    <code>returnCols</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#writableCols">
                                    <code>writableCols</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#searchableCols">
                                    <code>searchableCols</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#specificSorts">
                                    <code>specificSorts</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#groupByCols">
                                    <code>groupByCols</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#withQuery">
                                    <code>withQuery</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#permanentFilters">
                                    <code>permanentFilters</code>
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="chapter ">
                        <a href="./builderList.html">
                            <b>2.</b> All the query builders
                        </a>
                        <ul class="articles" style="display:none" >
                            <li class="chapter">
                                <a href="#selectOne">
                                    <code>selectOne</code>
                                </a>
                            </li>
                            <li class="chapter">
                                <a href="#select">
                                    <code>select</code>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </div>
        <div id="book-body" class="book-body">
            <div class="body-inner">
                <div class="page-wrapper" tabindex="-1" role="main">
                    <div class="page-inner">

                        <div id="book-search-results">
                            <div class="search-noresults">

                                <section class="normal markdown-section">

                                    <h1 id="postgres-queries">postgres-queries</h1>

<p>Utility to generate and execute postgresql queries with ease.</p>

<h2 id="install">Install</h2>

<p><code class="highlighter-rouge">npm install --save postgres-queries</code></p>

<h2 id="introduction">Introduction</h2>
<p>Creating query and executing them are two separate concerns. And thus postgres-queries is divided in two parts:</p>
<ul>
  <li>The pool, that allows to connect to the postgres database and execute query.</li>
  <li>The query builders (insertOne, selectOne, etc..) that allows to generate sql, and the corresponding parameters.</li>
</ul>

<h2 id="pool">Pool</h2>
<p>Extend <a href="https://github.com/brianc/node-pg-pool">node-pg-pool</a>
Allow to connect to postgresql and execute query
It adds:</p>
<ul>
  <li>namedQuery</li>
  <li>a link helper to link a query builder to the client.</li>
</ul>

<h3 id="creating-a-pool">Creating a pool:</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Pool</span> <span class="k">from</span> <span class="s1">'postgres-queries/pool'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">clientOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">user</span><span class="p">,</span>
    <span class="nx">password</span><span class="p">,</span>
    <span class="nx">database</span><span class="p">,</span>
    <span class="nx">host</span><span class="p">,</span>
    <span class="nx">port</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">poolingOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">max</span><span class="p">,</span> <span class="c1">// Max number of clients to create (defaults to 10)</span>
    <span class="nx">idleTimeoutMillis</span> <span class="c1">// how long a client is allowed to remain idle before being closed (defaults to 30 000 ms)</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pool</span><span class="p">(</span><span class="nx">clientOptions</span><span class="p">,</span> <span class="nx">poolingOptions</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="getting-client-with-promise">Getting client with promise</h3>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pgPool</span><span class="p">();</span>
<span class="nx">pool</span><span class="p">.</span><span class="nx">connect</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// use the client</span>
<span class="p">});</span>

<span class="c1">// async/await</span>
<span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pgPool</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">pool</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
<span class="p">})();</span>
</code></pre></div></div>

<h3 id="clientnamedquery">client.namedQuery</h3>

<p>The postgres-queries/pool allow you to execute named queries.</p>

<p>Normally to avoid sql injection, we use numeric placeholder for parameters</p>

<p>sql:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span>
    <span class="s1">'SELECT * FROM user WHERE id=$1 AND password=$2;'</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">id</span><span class="p">,</span> <span class="nx">password</span><span class="p">]</span>
<span class="p">);</span>
</code></pre></div></div>

<p>Then id and password will then be properly sanitized by the client.
But you have to keep track of the order, and this can become hard to work with.</p>

<p>postgres-queries/pool, support named query.
This allow us to name the parameter</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">namedQuery</span><span class="p">({</span>
    <span class="na">sql</span><span class="p">:</span> <span class="s1">'SELECT * FROM user WHERE id=$id AND password=$password;'</span><span class="p">,</span>
    <span class="na">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="s1">'id'</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="s1">'password'</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">})</span>
</code></pre></div></div>
<h3 id="api">api</h3>
<p>It takes a literal with the following keys</p>

<ul>
  <li>sql: the sql string</li>
  <li>parameters: a literal <code class="highlighter-rouge">{ parameterName: parameterValue }</code> to inject in the sql.</li>
  <li>returnOne: Optional boolean, if set to true, returns only the first result instead of an array.</li>
</ul>

<h3 id="clientlink">client.link</h3>
<p>Even if it’s good to separate the code to build the query from the code that execute them. At one time, we want to link the twos.
<code class="highlighter-rouge">client.link</code> links a queryBuilder function to the client so that it executes the query directly.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">selectOneById</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">link</span><span class="p">(</span><span class="nx">selectOneByIdBuilder</span><span class="p">);</span>
<span class="kr">await</span> <span class="nx">selectOneById</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// create and execute the query in one call.</span>
</code></pre></div></div>

<h2 id="query-builder">Query Builder</h2>
<p>The main idea behind the query builder is to be able to just give a configuration object:</p>
<ul>
  <li>the name of a table</li>
  <li>its primary key(s)</li>
  <li>the columns we want to read</li>
  <li>the columns we want to write</li>
</ul>

<p>And get a function asking for the query parameter:</p>
<ul>
  <li>id</li>
  <li>data object</li>
</ul>

<p>And returning queryData that can be directly passed to the <code class="highlighter-rouge">client.namedQuery</code> method.</p>

<p>Some builder even allows to create several builder at once.</p>

<p>For example the crud query builder give us builders to create queries for all basic crud operations:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// configuring the crud builder for the user table</span>
<span class="kd">const</span> <span class="nx">userQueries</span> <span class="o">=</span> <span class="nx">crud</span><span class="p">({</span>
    <span class="na">table</span><span class="p">:</span> <span class="s1">'user'</span><span class="p">,</span>
    <span class="na">primaryKey</span><span class="p">:</span> <span class="s1">'id'</span><span class="p">,</span>
    <span class="na">writableCols</span><span class="p">:</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'firstname'</span><span class="p">],</span>
<span class="p">});</span>

<span class="c1">// give us a collection of functions to query the user table :</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">selectOne</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="s1">'SELECT * FROM user WHERE id=$id;'</span><span class="p">,</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="nl">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">returnOne</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">select</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'doe'</span> <span class="p">});</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="s1">'SELECT * FROM user WHERE name=$name ORDER BY id ASC;'</span><span class="p">,</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span> <span class="nl">name</span><span class="p">:</span> <span class="s1">'doe'</span> <span class="p">},</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="na">firstname</span><span class="p">:</span> <span class="s1">'john'</span> <span class="p">});</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="p">(</span>
<span class="s2">`INSERT INTO user (name, firstname)
VALUES ($name, $firstname)
RETURNING *;`</span>
    <span class="p">),</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="nl">name</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span>
        <span class="nx">firstname</span><span class="p">:</span> <span class="s1">'john'</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">returnOne</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">batchInsert</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="na">firstname</span><span class="p">:</span> <span class="s1">'john'</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="na">firstname</span><span class="p">:</span> <span class="s1">'jane'</span> <span class="p">},</span>
<span class="p">]);</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="p">(</span>
<span class="s2">`INSERT INTO user(name, firstname)
VALUES ('doe', 'john'), ('doe', 'jane')
RETURNING *;`</span>
    <span class="p">),</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="nl">name1</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span>
        <span class="nx">firstname1</span><span class="p">:</span> <span class="s1">'john'</span><span class="p">,</span>
        <span class="nx">name2</span><span class="p">:</span> <span class="s1">'doe'</span><span class="p">,</span>
        <span class="nx">firstname2</span><span class="p">:</span> <span class="s1">'jane'</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="na">firstname</span><span class="p">:</span> <span class="s1">'johnny'</span> <span class="p">});</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="p">(</span>
<span class="s2">`UPDATE user SET firstname=$firstname
WHERE id=$id RETURNING *;`</span>
    <span class="p">),</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span>
        <span class="nl">id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">firstname</span><span class="p">:</span> <span class="s1">'johnny'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="s2">`DELETE FROM user WHERE id=$id RETURNING *;`</span><span class="p">,</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span> <span class="nl">id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
    <span class="nx">returnOne</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>
<span class="c1">//</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">batchRemove</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="p">(</span>
<span class="s2">`DELETE FROM user
WHERE id IN ($id1, $id2)
RETURNING *;`</span>
    <span class="p">),</span>
    <span class="nx">parameters</span><span class="p">:</span> <span class="p">{</span> <span class="nl">id1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">id2</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span>
<span class="p">}</span>

<span class="nx">userQueries</span><span class="p">.</span><span class="nx">countAll</span><span class="p">();</span>
<span class="c1">// returns:</span>
<span class="p">{</span>
    <span class="nl">sql</span><span class="p">:</span> <span class="s2">`SELECT COUNT(*) FROM user;`</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And all this get properly sanitized. You cannot set value to column not in writableCols for example.</p>

<p>See the docs for more details</p>


                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-46201426-1', 'auto');
            ga('send', 'pageview');
        </script>
        <script src="js/prism.js"></script>
</body>

</html>
